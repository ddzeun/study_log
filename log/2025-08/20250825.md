## LLM 기반 챗봇의 2단계 요청 라우팅

사용자의 다양한 발화를 정확한 비즈니스 로직으로 연결하기 위해, LLM을 활용한 2단계 라우팅(2-Step Routing) 아키텍처를 설계

### 1단계 라우터: 주 의도 분류 (Primary Intent Classification)

모든 사용자 요청은 먼저 1단계 라우터를 통과.\
사용자의 질문을 가장 광범위한 기능 카테고리 중 하나로 분류


```python
# app/services/chatbot.py

async def route_request_with_llm(user_message: str, llm: ChatOpenAI) -> str:
    prompt = f"""
사용자의 질문을 아래 다섯 가지 카테고리 중 가장 적합한 하나로 분류해주세요.
오직 카테고리 이름 하나만 답변해야 합니다.

[카테고리]
- greeting: 일반적인 인사, 도움 요청
- chat_summary: 채팅 내용 요약이나 정리 요청
- project_query: 프로젝트, 마일스톤, 이슈 관련 질문
- org_chart_query: 특정 인물, 부서, 직책 등 조직 정보 질문
- knowledge_query: 과거 대화, 회사 규정 등 저장된 지식 기반 질문

[사용자 질문]
"{user_message}"

[분류]
"""
    response = await llm.ainvoke(prompt)
    intent = response.content.strip().lower()
    # ...
```

### 2단계 라우터: 세부 의도 분류 (Secondary Intent Classification)

일부 주 의도는 그 자체로 여러 하위 작업을 포함.\
세부적인 의도를 구분하기 위해 2단계 라우터를 도입

1단계 라우터를 통해 특정 핸들러가 호출되면, 해당 핸들러 내부에서 다시 한번 LLM을 호출하여 세부 의도를 분류

```python
# app/services/handlers/org_chart_handler.py

async def classify_org_chart_query(user_message: str, llm: ChatOpenAI) -> str:
    prompt = f"""
사용자의 질문을 아래 두 가지 카테고리 중 더 적합한 하나로 분류해주세요.

[카테고리]
- specific_person: 특정 한 사람의 정보(연락처, 부서, 직책 등)를 묻는 질문
- general_query: 여러 명의 목록, 통계, 부서/직책 정보 등 일반적인 조직 정보를 묻는 질문

[사용자 질문]
"{user_message}"
"""
# ...
```

### 아키텍처의 장점

  * **확장성**: 새로운 기능을 추가할 때, `handler_map`에 새 핸들러를 등록하고 1단계 라우터의 프롬프트에 카테고리를 추가하기만 하면 되므로 기존 코드에 미치는 영향을 최소화
  * **유지보수성**: 각 기능이 독립된 핸들러 파일로 분리되어 있어 코드의 모듈성이 높고 관리가 용이
  * **정확성**: 두 번에 걸친 분류를 통해 사용자의 복잡하고 미묘한 의도를 훨씬 더 정확하게 파악하고, 각 상황에 최적화된 컨텍스트와 응답을 생성