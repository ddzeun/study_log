# 채팅방 메시지 무한 스크롤 구현

채팅방의 이전 메시지를 불러오기 위해 무한 스크롤 기능을 구현

### 1. 기본적인 무한 스크롤 구현

- **`react-intersection-observer` 라이브러리 활용**: `useInView` 훅을 사용해 메시지 목록 최상단에 보이지 않는 `<div>`(`topRef`)를 배치\
- **스크롤 감지**: 사용자가 스크롤을 올려 이 `<div>`가 화면에 보이게 되면(`inView` 상태가 `true`), 다음 페이지를 불러오는 함수(`onLoadMorePrev`)를 호출하도록 구현

### 2. 문제 상황

- **1) 스크롤 위치 이탈 현상**: 새로운 과거 메시지들이 목록의 위쪽에 추가되면서, 전체 스크롤 길이가 길어져 사용자가 보고 있던 화면의 위치가 아래로 튕겨 나가는(jump) 현상 발생

- **2) 중복 데이터 요청**: 사용자가 스크롤을 빠르게 올리거나, 트랙패드의 관성 스크롤(Inertia Scrolling) 때문에 `inView` 이벤트가 짧은 시간 안에 여러 번 발생하여 동일한 페이지를 중복으로 요청하는 문제 발생

### 3. 해결 방안

- **1) 스크롤 위치 보정**: `useRef`를 사용해 데이터 요청 직전의 스크롤 높이(`prevScrollHeightRef`)를 저장. 데이터가 로드된 후, 새로 늘어난 높이만큼 사용자의 스크롤 위치를 수동으로 조정하여 스크롤이 튕기지 않고 자연스럽게 유지되도록 처리

- **2) 중복 요청 방지**: 두 가지 장치를 사용해 중복 요청을 방지
    - **요청 잠금(Lock)**: 데이터 요청이 시작될 때 `isFetchingLockedRef`라는 `ref`를 `true`로 설정하여 잠금을 걸고, 요청이 완료되고 스크롤 위치 보정까지 끝난 후에야 `false`로 풀어주어 중복 실행을 원천적으로 차단
    - **디바운싱(Debouncing)**: `lodash`의 `debounce` 함수를 적용하여, `inView` 이벤트가 연속적으로 발생하더라도 마지막 이벤트 이후 일정 시간(300ms)이 지난 뒤에 딱 한 번만 데이터 요청 함수가 실행되도록 설정