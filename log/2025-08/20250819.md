# LLM 챗봇 구현하기

## 전체 흐름

- **사용자 (React)**: 챗봇에게 메시지 전송 → **스프링부트 서버**
- **스프링부트 서버**: 요청 수신 → LLM 기능이 필요함을 인지 → **파이썬 서버**에 "이 메시지 처리해줘" 라고 API 요청
- **파이썬 서버**: 스프링부트로부터 요청 수신 → OpenAI API 호출 및 응답 수신 → 받은 결과를 **스프링부트 서버**에 전달
- **스프링부트 서버**: 파이썬 서버로부터 결과 수신 → 최종적으로 **사용자 (React)**에게 응답 전달

### 1. 파이썬 LLM 서버 만들기 (FastAPI)

**외부(스프링부트)로부터 텍스트를 받아서, LLM을 통해 가공한 뒤, 그 결과를 돌려주는 서버**

### **1-1. 프로젝트 준비**

```Bash
# 1. 폴더 생성 및 이동
mkdir llm-python-server
cd llm-python-server

# 2. 가상환경 설정 및 활성화
python -m venv venv
source venv/bin/activate # macOS/Linux
# venv\Scripts\activate # Windows

# 3. 라이브러리 설치
pip install fastapi uvicorn openai python-dotenv
```

### **1-2. 코드 작성 (`main.py`)**

```Python
# main.py
import os
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from openai import OpenAI
from dotenv import load_dotenv

# .env 파일에서 환경 변수 로드
load_dotenv()

# FastAPI 앱 생성
app = FastAPI()

# OpenAI 클라이언트 초기화 (API 키는 환경변수에서 자동으로 읽어옴)
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# --- 데이터 형식 정의 (DTO 역할) ---
# 스프링부트가 보낼 요청 본문(Request Body) 형식
class LlmRequest(BaseModel):
    prompt: str
    # 필요하다면 다른 파라미터 추가 가능 (e.g., model: str, temperature: float)

# 스프링부트에게 돌려줄 응답 본문(Response Body) 형식
class LlmResponse(BaseModel):
    generated_text: str
# ------------------------------------

# --- API 엔드포인트 생성 ---
@app.post("/api/v1/generate", response_model=LlmResponse)
async def generate_text(request: LlmRequest):
    """
    LLM 텍스트 생성을 위한 API 엔드포인트
    """
    if not request.prompt:
        raise HTTPException(status_code=400, detail="Prompt cannot be empty")

    try:
        # 여기에 모든 LLM 관련 로직을 집중시킵니다.
        completion = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "You are a helpful assistant."},
                {"role": "user", "content": request.prompt}
            ]
        )
        result_text = completion.choices[0].message.content
        return LlmResponse(generated_text=result_text)

    except Exception as e:
        # 실제 운영 환경에서는 로깅(logging)을 통해 에러를 기록해야 합니다.
        print(f"An error occurred: {e}")
        raise HTTPException(status_code=500, detail="Failed to generate text from LLM")

```

### **1-3. API 키 설정 (`.env` 파일)**


### **1-4. 서버 실행**
```Bash
`uvicorn main:app --host 0.0.0.0 --port 8001 --reload`
```

이제 파이썬 서버는 `http://localhost:8001/api/v1/generate` 주소로 `POST` 요청을 받을 준비가 끝남

### 2. 스프링부트 서버에서 파이썬 서버 호출하기

### **2-1. 의존성 추가 (`build.gradle`)**

다른 서버와 HTTP 통신을 위한`WebClient`를 사용\
`spring-boot-starter-webflux` 추가

```Gradle
dependencies {
    // ... 다른 의존성들
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
}
```

### **2-2. 설정 파일 (`application.yml`)**

```YAML
# application.yml
python-server:
  url: http://localhost:8001
```

### **2-3. `WebClient` 설정 (`WebClientConfig.java`)**

프로젝트 전역에서 사용할 `WebClient`를 Bean으로 등록

```Java
`// config/WebClientConfig.java
package com.example.chatbot.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
public class WebClientConfig {

    @Value("${python-server.url}")
    private String pythonServerUrl;

    @Bean
    public WebClient webClient() {
        return WebClient.builder()
                .baseUrl(pythonServerUrl) // application.yml에 설정한 주소를 기본 URL로 사용
                .build();
    }
}`
```

### **2-4. 코드 작성 (Controller, Service, DTO)**

**`LlmService.java` (핵심 로직)** `WebClient`를 사용해서 파이썬 서버 호출

```Java
// service/LlmService.java
package com.example.chatbot.service;

import com.example.chatbot.dto.LlmRequestDto;
import com.example.chatbot.dto.LlmResponseDto;
import lombok.RequiredArgsConstructor;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

@Service
@RequiredArgsConstructor
public class LlmService {

    private final WebClient webClient; // Config에서 등록한 Bean을 주입받음

    public String generateText(String prompt) {
        // 1. 파이썬 서버에 보낼 요청 DTO 생성
        LlmRequestDto requestDto = new LlmRequestDto(prompt);

        // 2. WebClient를 사용해 비동기 POST 요청 전송
        LlmResponseDto responseDto = webClient.post()
                .uri("/api/v1/generate") // 기본 URL 뒤에 붙는 상세 경로
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(requestDto) // 요청 본문에 DTO를 담음
                .retrieve() // 응답을 받기 시작
                .bodyToMono(LlmResponseDto.class) // 응답 본문을 DTO로 변환
                .block(); // 비동기 작업이 끝날 때까지 기다림 (결과를 동기적으로 얻음)

        if (responseDto == null) {
            // 실제로는 Custom Exception을 만들어서 처리하는 것이 좋음
            throw new RuntimeException("LLM 서버로부터 응답을 받지 못했습니다.");
        }
        return responseDto.getGeneratedText();
    }
}
```

**파이썬 서버와 주고받을 DTO 정의
```Java

import lombok.AllArgsConstructor;
import lombok.Getter;

@Getter
@AllArgsConstructor
public class LlmRequestDto {
    private String prompt;
}
```
```java
import lombok.Getter;
import lombok.NoArgsConstructor;

@Getter
@NoArgsConstructor
public class LlmResponseDto {
    private String generatedText;
}
```

**Controller: React 클라이언트의 최종 요청을 받는 부분.
```Java
import com.example.chatbot.service.LlmService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequiredArgsConstructor
public class ChatController {

    private final LlmService llmService;

    // 간단한 예시를 위해 요청 DTO를 Map으로 받음
    @PostMapping("/api/chat")
    public String chat(@RequestBody java.util.Map<String, String> request) {
        String userMessage = request.get("message");
        // LlmService를 호출하여 파이썬 서버와 통신
        return llmService.generateText(userMessage);
    }
}
```

### 3. 실행 및 테스트

3-1.
**터미널 1**: `llm-python-server` 폴더에서 파이썬 서버 실행
```Bash
uvicorn main:app --port 8001
```

3-2. 스프링부트 서버 실행

3-3. 엔드포인트 요청 테스트